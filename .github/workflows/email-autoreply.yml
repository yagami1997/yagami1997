name: Email Request Handler

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  issues: write

jobs:
  initial-response:
    runs-on: ubuntu-latest
    # 简化条件判断，只检查issue标题
    if: github.event_name == 'issues' && contains(github.event.issue.title, 'Email')
    steps:
      - name: Send Initial Response
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          # 创建初始回复
          gh issue comment "$ISSUE_NUMBER" --body "## 🕵️‍♂️ Mission Received: Secure Communication Request 🕵️‍♀️

          Well hello there, fellow encryption enthusiast! Your request for my super-secret contact details has successfully reached my digital fortress.

          I see you've discovered my cryptographic hideout - impressive! But as any good spy knows, verification is key before exchanging classified information.

          **Your mission, should you choose to accept it:**
          Tell me a bit about why you'd like to establish this encrypted communication channel. Are we planning to discuss revolutionary open-source ideas? Trading secrets about the fifth industrial revolution? Or perhaps you just appreciate the art of properly encrypted emails in this age of digital surveillance?

          Your request is now in the secret approval queue. Once I've confirmed you're not an agent from the anti-open-source league, I'll transmit my secure communication coordinates.

          Stay encrypted, stay free! 🔐

          *This message will NOT self-destruct in 10 seconds, because that would be a waste of perfectly good bits and bytes.*"
          
          # 添加标签
          gh issue edit "$ISSUE_NUMBER" --add-label "pending-approval"
        env:
          GH_TOKEN: ${{ github.token }}

  approve-request:
    runs-on: ubuntu-latest
    # 仅在有评论并且包含特定关键词时触发
    if: github.event_name == 'issue_comment' && contains(github.event.comment.body, 'Fox 3') && github.event.comment.user.login == github.repository_owner
    steps:
      - name: Send Contact Info
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          # 发送批准消息和联系信息
          gh issue comment "$ISSUE_NUMBER" --body "### 🔐 Request Approved

          Thank you for your patience! Your request has been approved.

          Here's my contact information for secure communication:

          #### 📧 Email Address:
          \`\`\`
          ${{ secrets.CONTACT_EMAIL }}
          \`\`\`

          #### 🔑 GPG Key Instructions:
          \`\`\`bash
          # Import my public key from keyserver
          gpg --keyserver hkps://keys.openpgp.org --recv-keys ${{ secrets.GPG_KEY }}

          # Verify fingerprint before sending sensitive data
          gpg --fingerprint ${{ secrets.GPG_KEY }}
          \`\`\`

          I look forward to our encrypted conversation!"
          
          # 更新标签
          gh issue edit "$ISSUE_NUMBER" --remove-label "pending-approval"
          gh issue edit "$ISSUE_NUMBER" --add-label "approved"
        env:
          GH_TOKEN: ${{ github.token }}
